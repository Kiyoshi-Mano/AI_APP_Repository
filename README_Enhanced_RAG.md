# 🚀 拡張RAG社内規定チャットボット

## 📋 概要

従来のシンプルな回答形式から、構造化されたJSON出力による詳細な回答システムに拡張しました。

### ✨ 新機能

1. **📝 構造化回答**: 簡潔な回答 + 詳細な解説
2. **🔍 引用ハイライト**: 原文の重要部分を正確に引用
3. **📚 出典管理**: チャンクごとの信頼度表示
4. **💡 解説機能**: 背景情報や注意点の詳細説明

## 🛠️ 技術仕様

### システム構成
```
app.py                  # 拡張Streamlitアプリ
├── RAGChatbot クラス
├── 構造化JSON応答処理
└── 拡張UI表示機能

utils/
├── text_chunk.py       # チャンク化処理
└── pinecone_io.py      # Pinecone連携

test_enhanced_rag.py    # 拡張機能テストスクリプト
```

### JSON出力構造
```json
{
  "answer": "質問に対する簡潔な結論",
  "explanation": "詳細な解説・背景・注意点",
  "highlights": [
    {
      "source_id": "company_policies",
      "chunk_index": 3,
      "span": [10, 48],
      "quote": "引用テキスト"
    }
  ],
  "sources": [
    {
      "source_id": "company_policies", 
      "chunk_index": 3,
      "confidence": "High"
    }
  ]
}
```

## 🖥️ UI機能

### サイドバー設定
- **検索結果数**: 1-10件の範囲で調整可能
- **コンテキスト表示**: 従来の検索チャンク表示
- **ハイライト表示**: 引用部分の詳細表示
- **出典表示**: 信頼度付き出典情報

### チャット表示
- **📝 回答**: メイン回答部分
- **💡 解説**: 背景・注意点の詳細説明
- **🔍 引用ハイライト**: 原文引用とチャンク位置
- **📚 出典情報**: 信頼度に応じた色分け表示
  - 🟢 High: 高信頼度
  - 🟡 Med: 中信頼度  
  - 🔴 Low: 低信頼度

## 🚀 使用方法

### 1. データ処理（初回のみ）
```bash
python rag.py --input data/company_policies_rag_dataset.txt --push-pinecone
```

### 2. 拡張チャットアプリ起動
```bash
streamlit run app.py
```
アプリ: http://localhost:8501

### 3. 拡張機能テスト
```bash
python test_enhanced_rag.py
```

## 📊 テスト結果例

**質問**: "フレックスタイムのコアタイムは何時ですか？"

**回答構造**:
- **📝 回答**: "10時〜15時"
- **💡 解説**: "フレックスタイム制の詳細ルールと背景説明..."
- **🔍 引用**: "フレックスタイム制の対象部署においては、コアタイムを10時〜15時とし..."
- **📚 出典**: チャンク1 (信頼度: High)

## ✅ 改良ポイント

### 従来 → 拡張後
- **回答形式**: テキスト → 構造化JSON
- **情報の深さ**: 基本回答 → 回答+解説+引用
- **根拠の明示**: なし → ハイライト+出典+信頼度
- **UI体験**: シンプル → リッチな情報表示

### プロンプト最適化
- JSON出力の厳格化
- 引用位置の正確な指定
- 信頼度評価の組み込み
- 説明の構造化（要点・背景・注意点）

## 🎯 効果

1. **回答品質向上**: 根拠が明確で信頼性が高い回答
2. **ユーザビリティ**: 情報の詳細度を設定で調整可能
3. **監査性**: 全ての回答に対する出典追跡が可能
4. **学習効果**: 解説により規定の理解が深まる

## 🔧 設定

### 環境変数（必須）
```bash
OPENAI_API_KEY=your_openai_key
PINECONE_API_KEY=your_pinecone_key  
PINECONE_INDEX_NAME=company-policies-embeddings
PINECONE_NAMESPACE=policies-v1
```

### モデル設定
- **埋め込み**: `text-embedding-3-small` (1536次元)
- **回答生成**: `gpt-3.5-turbo`
- **ベクトルDB**: Pinecone (コサイン距離)

拡張RAGシステムにより、従来の基本的な質疑応答から、根拠と詳細説明を備えた高品質な情報提供システムに進化しました。